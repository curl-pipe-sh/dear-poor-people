#!/usr/bin/env sh
# description: minimal interactive TTY bridge (like socat)
# icon: mdi:transit-connection-variant
# poorcat.sh â€” minimal interactive TTY bridge (like socat)

# shellcheck disable=SC2034  # Used by usage function
SCRIPT_NAME="poorsocat"

# Source echo utilities - this line gets replaced during templating
# shellcheck disable=SC1091  # File is included via templating
. lib/echo.sh # <TEMPLATE>

usage() {
  cat <<USAGE >&2
Usage: ${SCRIPT_NAME} [--debug] [--trace] DEVICE [BAUD]

A minimal interactive TTY bridge for serial communication.

Arguments:
  DEVICE    Serial device (e.g., /dev/ttyUSB0, /dev/ttyACM0)
  BAUD      Baud rate (default: 115200)

Options:
  --debug          Enable debug output
  --trace          Enable shell tracing (set -x)
  -h, --help       Show this help message

Examples:
  ${SCRIPT_NAME} /dev/ttyUSB0           # Connect to USB serial at 115200 baud
  ${SCRIPT_NAME} /dev/ttyACM0 9600      # Connect to Arduino at 9600 baud
  ${SCRIPT_NAME} /dev/ttyS0 38400       # Connect to serial port at 38400 baud

Note: You may need appropriate permissions to access serial devices.
      Try adding your user to the 'dialout' group: sudo usermod -a -G dialout \$USER
USAGE
}

# Parse arguments
case "${1:-}" in
  --debug)
    DEBUG=1
    export DEBUG  # Export for use by echo.sh functions
    shift
    ;;
  --trace)
    set -x
    shift
    ;;
esac

case "${1:-}" in
  -h|--help)
    usage
    exit 0
    ;;
  "")
    echo_error "Error: DEVICE argument required"
    echo_error "Usage: ${SCRIPT_NAME} DEVICE [BAUD]"
    echo_error "A minimal interactive TTY bridge for serial communication."
    usage
    exit 2
    ;;
esac

DEVICE="$1"
BAUD="${2:-115200}"

# Configure TTY (ignore errors if unsupported)
stty -F "$DEVICE" "$BAUD" -echo -icanon 2>/dev/null || \
stty "$BAUD" -echo -icanon 2>/dev/null < "$DEVICE" || true

# Start background reader
cat < "$DEVICE" &
READER_PID=$!

cleanup() {
  kill "$READER_PID" 2>/dev/null
}
trap cleanup EXIT INT TERM

# Main loop: read from stdin, write to device
while IFS= read -r line
do
  # send line with CR
  printf '%s\r' "$line" > "$DEVICE"
done
